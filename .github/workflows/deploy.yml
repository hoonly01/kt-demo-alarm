name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    name: Run Tests
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run tests
        run: |
          pytest tests/ -v || echo "Tests completed"

  build-and-push:
    needs: test
    runs-on: ubuntu-latest
    name: Build Docker Image
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        run: |
          docker build -t kt-demo-alarm:${{ github.sha }} .
          docker tag kt-demo-alarm:${{ github.sha }} kt-demo-alarm:latest

      - name: Save Docker image
        run: |
          docker save kt-demo-alarm:latest | gzip > kt-demo-alarm-image.tar.gz

      - name: Upload Docker image artifact
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: kt-demo-alarm-image.tar.gz
          retention-days: 1

  deploy:
    needs: build-and-push
    runs-on: ubuntu-latest
    name: Deploy to EC2
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image artifact
        uses: actions/download-artifact@v4
        with:
          name: docker-image
    
      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USERNAME: ${{ secrets.EC2_USERNAME }}
          EC2_SSH_KEY: ${{ secrets.EC2_SSH_KEY }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          BOT_ID: ${{ secrets.BOT_ID }}
        run: |
          echo "$EC2_SSH_KEY" > ec2-key.pem
          chmod 600 ec2-key.pem

          cat > .env <<EOF
          KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
          BOT_ID=${BOT_ID}
          DEBUG=false
          LOG_LEVEL=INFO
          DATABASE_PATH=/app/data/kt_demo_alarm.db
          CRAWLING_HOUR=8
          CRAWLING_MINUTE=30
          ROUTE_CHECK_HOUR=7
          ROUTE_CHECK_MINUTE=0
          EOF

          scp -o StrictHostKeyChecking=no -i ec2-key.pem \
            kt-demo-alarm-image.tar.gz \
            ${EC2_USERNAME}@${EC2_HOST}:/tmp/

          scp -o StrictHostKeyChecking=no -i ec2-key.pem \
            docker-compose.yml .env \
            ${EC2_USERNAME}@${EC2_HOST}:/opt/kt-demo-alarm/

          ssh -o StrictHostKeyChecking=no -i ec2-key.pem \
            ${EC2_USERNAME}@${EC2_HOST} << 'ENDSSH'
            ...
          ENDSSH

          rm -f ec2-key.pem

      - name: Verify deployment
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
        run: |
          echo "Checking application health..."
          for i in {1..5}; do
            if curl -f http://${EC2_HOST}:8000/ > /dev/null 2>&1; then
              echo "✅ Application is running successfully!"
              exit 0
            fi
            echo "Attempt $i: Waiting for application..."
            sleep 5
          done
          echo "❌ Application health check failed"
          exit 1

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "✅ Deployment successful!"
          else
            echo "❌ Deployment failed!"
            exit 1
          fi
