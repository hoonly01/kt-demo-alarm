name: Deploy to AWS EC2

on:
  push:
    branches:
      - main
  workflow_dispatch:  # ÏàòÎèô Ïã§Ìñâ Í∞ÄÎä•

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to EC2
        env:
          EC2_HOST: ${{ secrets.EC2_HOST }}
          EC2_USER: ${{ secrets.EC2_USER }}
          KAKAO_REST_API_KEY: ${{ secrets.KAKAO_REST_API_KEY }}
          BOT_ID: ${{ secrets.BOT_ID }}
        run: |
          ssh ${EC2_USER}@${EC2_HOST} << 'EOF'
            set -e

            echo "üì¶ Deploying KT Demo Alarm to EC2..."

            # ÌîÑÎ°úÏ†ùÌä∏ ÎîîÎ†âÌÜ†Î¶¨Î°ú Ïù¥Îèô
            cd ~/kt-demo-alarm || exit 1

            # Git pull
            echo "‚¨áÔ∏è  Pulling latest code..."
            git pull origin main

            # ÌôòÍ≤ΩÎ≥ÄÏàò ÏóÖÎç∞Ïù¥Ìä∏ (.env ÌååÏùº ÏÉùÏÑ±/ÏóÖÎç∞Ïù¥Ìä∏)
            echo "üîê Updating environment variables..."
            cat > .env << ENVEOF
          KAKAO_REST_API_KEY=${KAKAO_REST_API_KEY}
          BOT_ID=${BOT_ID}
          PORT=8000
          DEBUG=false
          LOG_LEVEL=INFO
          DATABASE_PATH=/app/data/kt_demo_alarm.db
          CRAWLING_HOUR=8
          CRAWLING_MINUTE=30
          ROUTE_CHECK_HOUR=7
          ROUTE_CHECK_MINUTE=0
          ENVEOF

            # Docker Ïù¥ÎØ∏ÏßÄ ÎπåÎìú
            echo "üî® Building Docker image..."
            docker-compose build

            # Í∏∞Ï°¥ Ïª®ÌÖåÏù¥ÎÑà Ï§ëÏßÄ Î∞è Ï†úÍ±∞
            echo "üõë Stopping old containers..."
            docker-compose down || true

            # ÏÉà Ïª®ÌÖåÏù¥ÎÑà ÏãúÏûë
            echo "üöÄ Starting new containers..."
            docker-compose up -d

            # Ìó¨Ïä§Ï≤¥ÌÅ¨
            echo "üè• Checking health..."
            sleep 5
            if curl -f http://localhost:8000/ > /dev/null 2>&1; then
              echo "‚úÖ Deployment successful!"
            else
              echo "‚ùå Health check failed!"
              docker-compose logs --tail=50
              exit 1
            fi

            # Î°úÍ∑∏ Ï∂úÎ†•
            echo "üìä Recent logs:"
            docker-compose logs --tail=20
          EOF

      - name: Cleanup SSH
        if: always()
        run: rm -rf ~/.ssh/id_rsa

      - name: Notify deployment status
        if: always()
        run: |
          if [ ${{ job.status }} == 'success' ]; then
            echo "‚úÖ Deployment completed successfully!"
          else
            echo "‚ùå Deployment failed!"
          fi
